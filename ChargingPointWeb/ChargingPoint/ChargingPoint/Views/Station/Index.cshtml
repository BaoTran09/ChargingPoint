@model IEnumerable<ChargingPoint.DB.Station>

@{
    ViewData["Title"] = "Danh sách trạm sạc vGreen";
}

<h1>Trạm sạc vGreen</h1>

<p>
    <a asp-action="Create" class="btn btn-primary">Thêm trạm mới</a>
</p>

@await Html.PartialAsync("Search")

<div style="max-height: 400px; overflow-y: auto; margin-bottom: 50px;">
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>@Html.DisplayNameFor(model => model.Tag)</th>
                <th>@Html.DisplayNameFor(model => model.Name)</th>
                <th>@Html.DisplayNameFor(model => model.StationType)</th>
                <th>@Html.DisplayNameFor(model => model.Address)</th>
                <th>@Html.DisplayNameFor(model => model.Latitude)</th>
                <th>@Html.DisplayNameFor(model => model.Longitude)</th>
                <th>@Html.DisplayNameFor(model => model.Notes)</th>
               @* 
                <th>@Html.DisplayNameFor(model => model.CreatedAt)</th>
                <th>@Html.DisplayNameFor(model => model.BuiltDate)</th>
                *@
                <th>Hành động</th>
                <th>Phiên sạc</th>

            </tr>
        </thead>
        <tbody id="stationTableBody">
            @foreach (var item in Model)
            {
                <tr data-lat="@item.Latitude" data-lon="@item.Longitude" style="cursor: pointer;">
                    <td>@Html.DisplayFor(modelItem => item.Tag)</td>
                    <td>@Html.DisplayFor(modelItem => item.Name)</td>
                    <td>@Html.DisplayFor(modelItem => item.StationType)</td>
                    <td>@Html.DisplayFor(modelItem => item.Address)</td>
                    <td>@Html.DisplayFor(modelItem => item.Latitude)</td>
                    <td>@Html.DisplayFor(modelItem => item.Longitude)</td>
                    <td>@Html.DisplayFor(modelItem => item.Notes)</td>
                    <td>
                        <a asp-action="Detail" asp-controller="ChargingSession" asp-route-stationId="@item.StationId" class="btn btn-info btn-sm">Xem phiên sạc</a>
                    </td>
                    @*
                    <td>@Html.DisplayFor(modelItem => item.CreatedAt)</td>
                    <td>@Html.DisplayFor(modelItem => item.BuiltDate)</td>
                     *@
                    <td>
                        <a asp-action="Details" asp-route-id="@item.StationId" class="btn btn-info btn-sm">Chi tiết</a>
                        <a asp-action="Edit" asp-route-id="@item.StationId" class="btn btn-warning btn-sm">Sửa</a>
                        <a asp-action="Delete" asp-route-id="@item.StationId" class="btn btn-danger btn-sm">Xóa</a>
                    </td>
                    <td>@item.StationId</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div id="map" style="width: 100%; height: 400px; border: 1px solid #ddd; border-radius: 5px;"></div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

@section Scripts {
    <script>
        // Khởi tạo bản đồ Leaflet
        window.map = L.map('map').setView([16.0471, 108.2068], 6);
        window.markers = L.layerGroup();
        window.jsModel = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));

        // Tùy chỉnh icon cho marker
        var location_icon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });

        // Thêm tile layer từ OpenStreetMap
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(window.map);

        // Định nghĩa khung nhìn cho các miền
        const regionBounds = {
            North: [[19.8, 102.0], [23.5, 109.5]],
            Center: [[11.5, 106.0], [19.8, 110.0]],
            South: [[8.5, 104.0], [11.5, 109.0]]
        };

        // Hàm loadMarkers
        function loadMarkers(data) {
            window.markers.clearLayers();
            var bounds = [];
            data.forEach(function (item) {
                // Kiểm tra cả lowercase (từ /Station/Search) và uppercase (từ window.jsModel)
                var lat = parseFloat(item.latitude || item.Latitude);
                var lon = parseFloat(item.longitude || item.Longitude);
                if (!isNaN(lat) && !isNaN(lon) && lat !== null && lon !== null) {
                    var marker = L.marker([lat, lon], { icon: location_icon })
                        .bindPopup(`
                                    <b>${item.name || item.Name || 'N/A'}</b><br>
                                    Địa chỉ: ${item.address || item.Address || 'N/A'}<br>
                                    Loại trạm: ${item.stationType || item.StationType || 'N/A'}<br>
                                    ID: ${item.stationId || item.StationId}<br>
                                    Ghi chú: ${item.notes || item.Notes || 'N/A'}
                                `);
                    window.markers.addLayer(marker);
                    bounds.push([lat, lon]);
                } else {
                    console.warn('Tọa độ không hợp lệ cho trạm:', item);
                }
            });
            window.markers.addTo(window.map);
            console.log('Markers loaded:', bounds);
            return bounds;
        }

        // Hàm updateTable
        function updateTable(data) {
            var tbody = $('#stationTableBody');
            tbody.empty();
            console.log('Updating table with data:', data);
            if (data.length === 0) {
                tbody.append('<tr><td colspan="10">Không tìm thấy trạm nào.</td></tr>');
            } else {
                data.forEach(function (item) {
                    var row = `
                                <tr data-lat="${item.latitude || item.Latitude || ''}" data-lon="${item.longitude || item.Longitude || ''}" style="cursor: pointer;">
                                    <td>${item.tag || item.Tag || ''}</td>
                                    <td>${item.name || item.Name || ''}</td>
                                    <td>${item.stationType || item.StationType || ''}</td>
                                    <td>${item.address || item.Address || ''}</td>
                                    <td>${item.latitude || item.Latitude || ''}</td>
                                    <td>${item.longitude || item.Longitude || ''}</td>
                                    <td>${item.notes || item.Notes || ''}</td>
                                    <td>${item.createdAt || item.CreatedAt || ''}</td>
                                    <td>${item.builtDate || item.BuiltDate || ''}</td>
                                    <td>
                                        <a href="/Station/Details/${item.stationId || item.StationId}" class="btn btn-info btn-sm">Chi tiết</a>
                                        <a href="/Station/Edit/${item.stationId || item.StationId}" class="btn btn-warning btn-sm">Sửa</a>
                                        <a href="/Station/Delete/${item.stationId || item.StationId}" class="btn btn-danger btn-sm">Xóa</a>
                                    </td>
                                </tr>`;
                    tbody.append(row);
                });
            }

            $('table tbody tr').click(function (e) {
                if ($(e.target).is('a') || $(e.target).parents('a').length) {
                    return;
                }
                var lat = parseFloat($(this).data('lat'));
                var lon = parseFloat($(this).data('lon'));
                if (!isNaN(lat) && !isNaN(lon)) {
                    window.map.setView([lat, lon], 15);
                    console.log('Zoomed to station:', lat, lon);
                } else {
                    console.warn('Tọa độ không hợp lệ cho hàng:', $(this).data());
                }
            });
        }

        // Hàm updateMapForRegions
        function updateMapForRegions(searchNorth, searchCenter, searchSouth, data) {
            var bounds = [];
            // Thêm bounds của miền nếu được chọn
            if (searchNorth) bounds.push(...regionBounds.North);
            if (searchCenter) bounds.push(...regionBounds.Center);
            if (searchSouth) bounds.push(...regionBounds.South);

            // Thêm bounds của các marker
            var markerBounds = data
                .filter(item => !isNaN(parseFloat(item.latitude || item.Latitude)) && !isNaN(parseFloat(item.longitude || item.Longitude)))
                .map(item => [parseFloat(item.latitude || item.Latitude), parseFloat(item.longitude || item.Longitude)]);

            if (markerBounds.length > 0) {
                bounds = bounds.concat(markerBounds);
            }

            if (bounds.length > 0) {
                window.map.fitBounds(bounds);
                console.log('Zoomed to bounds:', bounds);
            } else {
                window.map.setView([16.0471, 108.2068], 6);
                console.log('Zoomed to default Vietnam view');
            }
        }

        // Hàm performSearch
        function performSearch() {
            var searchString = $('#searchInput').val();
            var searchNorth = $('#searchNorth').is(':checked');
            var searchCenter = $('#searchCenter').is(':checked');
            var searchSouth = $('#searchSouth').is(':checked');
            console.log('Performing search:', { searchString, searchNorth, searchCenter, searchSouth });

            $.ajax({
                url: '/Station/Search',
                data: {
                    searchString: searchString,
                    searchNorth: searchNorth,
                    searchCenter: searchCenter,
                    searchSouth: searchSouth
                },
                dataType: 'json',
                success: function (data) {
                    console.log('Search results:', data);
                    updateTable(data);
                    var bounds = loadMarkers(data);
                    // Luồng a: Nếu tìm kiếm và chỉ có 1 kết quả, zoom vào station
                    if (searchString && data.length === 1) {
                        var item = data[0];
                        var lat = parseFloat(item.latitude || item.Latitude);
                        var lon = parseFloat(item.longitude || item.Longitude);
                        if (!isNaN(lat) && !isNaN(lon)) {
                            window.map.setView([lat, lon], 15);
                            console.log('Zoomed to single station:', lat, lon);
                        } else {
                            window.map.setView([16.0471, 108.2068], 6);
                            console.log('Zoomed to default view due to invalid coordinates');
                        }
                    } else {
                        // Luồng b: Zoom bao quát các marker hoặc miền
                        updateMapForRegions(searchNorth, searchCenter, searchSouth, data);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi tìm kiếm:', error, xhr.status, xhr.responseText);
                    updateTable([]);
                }
            });
        }
        

        // Khởi tạo khi trang tải
        $(document).ready(function () {
            console.log('Index loaded');
            if (typeof $.ui === 'undefined' || typeof $.ui.autocomplete === 'undefined') {
                console.error('jQuery UI or Autocomplete not loaded! Check wwwroot/lib/jquery-ui/dist');
            } else {
                $('#searchInput').autocomplete({
                    source: function (request, response) {
                        $.ajax({
                            url: '/Station/SearchSuggestions',
                            data: { term: request.term },
                            dataType: 'json',
                            success: function (data) {
                                console.log('Autocomplete suggestions:', data);
                                response(data);
                            },
                            error: function (xhr, status, error) {
                                console.error('Lỗi autocomplete:', error, xhr.status, xhr.responseText);
                            }
                        });
                    },
                    minLength: 2,
                    select: function (event, ui) {
                        $('#searchInput').val(ui.item.value);
                        performSearch();
                    }
                });
            }

            // Load marker ban đầu từ Model
            var initialBounds = loadMarkers(window.jsModel);
            if (initialBounds.length > 0) {
                window.map.fitBounds(initialBounds);
            } else {
                console.warn('No valid initial markers, using default view');
                window.map.setView([16.0471, 108.2068], 6);
            }

            $('#searchForm').on('submit', function (e) {
                e.preventDefault();
                performSearch();
            });

            $('#searchNorth, #searchCenter, #searchSouth').change(function () {
                console.log('Checkbox changed:', this.id, this.checked);
                performSearch();
            });

            $('table tbody tr').click(function (e) {
                if ($(e.target).is('a') || $(e.target).parents('a').length) {
                    return;
                }
                var lat = parseFloat($(this).data('lat'));
                var lon = parseFloat($(this).data('lon'));
                if (!isNaN(lat) && !isNaN(lon)) {
                    window.map.setView([lat, lon], 15);
                    console.log('Zoomed to station:', lat, lon);
                } else {
                    console.warn('Tọa độ không hợp lệ cho hàng:', $(this).data());
                }
            });
        });
    </script>
}
    <style>
        #map {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .ui-autocomplete {
            max-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid #ddd;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

            .ui-autocomplete .ui-menu-item {
                padding: 8px;
                cursor: pointer;
            }

                .ui-autocomplete .ui-menu-item:hover {
                    background-color: #f0f0f0;
                }
    </style>
