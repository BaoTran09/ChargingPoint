@model ChargingPoint.Models.ChargingSession

@{
    ViewData["Title"] = "Chi Tiết Phiên Sạc";
    var isCustomerView = User.IsInRole("Customer");
    var canControl = !isCustomerView;
}

<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3><i class="fas fa-bolt"></i> Phiên Sạc #@Model.SessionId</h3>
            <p class="text-muted mb-0">
                <i class="fas fa-clock"></i> Bắt đầu: @(Model.StartTime?.ToString("HH:mm dd/MM/yyyy") ?? "Chưa bắt đầu")
            </p>
        </div>
        <div>
            @{
                var statusClass = Model.Status switch
                {
                    "Requiring" => "warning",
                    "Charging" => "primary",
                    "PoweredOff" => "info",
                    "Completed" => "success",
                    "Stopped" => "danger",
                    "Rejected" => "dark",
                    _ => "secondary"
                };
            }
            <span class="badge bg-@statusClass badge-lg">@Model.Status.ToUpper()</span>
        </div>
    </div>

    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-7">
            <!-- Vehicle & Station Info -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Thông Tin</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-car"></i> Xe</h6>
                            <div class="info-box">
                                <div class="info-item">
                                    <span class="label">Biển số:</span>
                                    <strong>@(Model.Vehicle?.LicensePlate ?? "N/A")</strong>
                                </div>
                                <div class="info-item">
                                    <span class="label">Xe:</span>
                                    <span>@(Model.Vehicle != null ? $"{Model.Vehicle.Manufacturer} {Model.Vehicle.Model}".Trim() : "N/A")</span>
                                </div>
                                @if (!isCustomerView && Model.Vehicle?.Customer != null)
                                {
                                    <div class="info-item">
                                        <span class="label">Chủ xe:</span>
                                        <span>@Model.Vehicle.Customer.FullName</span>
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-charging-station"></i> Trạm Sạc</h6>
                            <div class="info-box">
                                <div class="info-item">
                                    <span class="label">Trạm:</span>
                                    <strong>@(Model.Connector?.Charger?.Station?.Name ?? "N/A")</strong>
                                </div>
                                <div class="info-item">
                                    <span class="label">Trụ:</span>
                                    <span>@(Model.Connector?.Charger?.Name ?? Model.Connector?.Charger?.Model ?? "N/A")</span>
                                </div>
                                <div class="info-item">
                                    <span class="label">Cổng:</span>
                                    <span>@(Model.Connector?.ConnectorType ?? "N/A") (Cổng @(Model.Connector?.ConnectorIndex ?? 0))</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charging Progress -->
            @if (Model.Status == "Charging" || Model.Status == "PoweredOff")
            {
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-battery-half"></i> Tiến Trình Sạc</h5>
                    </div>
                    <div class="card-body">
                        <div class="progress-info mb-3">
                            <div class="d-flex justify-content-between">
                                <span>SOC: <strong id="currentSOC">@(Model.StartSOC?.ToString("F1") ?? "0")%</strong></span>
                                <span>Mục tiêu: <strong>@(Model.TargetSOC?.ToString("F1") ?? "80")%</strong></span>
                            </div>
                        </div>
                        <div class="progress" style="height: 30px;">
                            <div id="chargingProgress" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                 role="progressbar" style="width: 0%">
                                <span id="progressText">0%</span>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <div id="statusMessage" class="text-muted"></div>
                            <div id="remainingTime" class="text-primary fw-bold"></div>
                        </div>
                        @if (Model.ExpectTime.HasValue)
                        {
                            <div class="alert alert-info mt-3 mb-0">
                                <i class="fas fa-clock"></i> <strong>Dự kiến hoàn tất:</strong> @Model.ExpectTime.Value.ToString("HH:mm dd/MM/yyyy")
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Energy Details -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Chi Tiết Năng Lượng</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="stat-box">
                                <div class="stat-icon bg-primary"><i class="fas fa-battery-quarter"></i></div>
                                <div class="stat-content">
                                    <div class="stat-label">SOC Bắt Đầu</div>
                                    <div class="stat-value">@(Model.StartSOC?.ToString("F1") ?? "--")%</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stat-box">
                                <div class="stat-icon bg-success"><i class="fas fa-battery-full"></i></div>
                                <div class="stat-content">
                                    <div class="stat-label">SOC Kết Thúc</div>
                                    <div class="stat-value">@(Model.EndSOC?.ToString("F1") ?? "--")%</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stat-box">
                                <div class="stat-icon bg-warning"><i class="fas fa-bolt"></i></div>
                                <div class="stat-content">
                                    <div class="stat-label">Năng Lượng</div>
                                    <div class="stat-value">@(Model.EnergyDeliveredKWh?.ToString("F2") ?? "0.00") kWh</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stat-box">
                                <div class="stat-icon bg-danger"><i class="fas fa-clock"></i></div>
                                <div class="stat-content">
                                    <div class="stat-label">Thời Gian</div>
                                    <div class="stat-value">
                                        @if (Model.StartTime.HasValue && Model.PowerOffTime.HasValue)
                                        {
                                            var duration = Model.PowerOffTime.Value - Model.StartTime.Value;
                                            <text>@($"{(int)duration.TotalHours}h {duration.Minutes}m")</text>
                                        }
                                        else
                                        {
                                            <text>--</text>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-5">
            <!-- Control Panel -->
            @if (canControl)
            {
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-sliders-h"></i> Điều Khiển</h5>
                    </div>
                    <div class="card-body">
                        @if (Model.Status == "Requiring")
                        {
                            <button class="btn btn-success w-100 mb-2" onclick="approveCharging(@Model.SessionId)">
                                <i class="fas fa-check"></i> Phê Duyệt
                            </button>
                            <button class="btn btn-danger w-100" onclick="rejectCharging(@Model.SessionId)">
                                <i class="fas fa-times"></i> Từ Chối
                            </button>
                        }
                        else if (Model.Status == "Charging")
                        {
                            <button class="btn btn-danger w-100" onclick="stopCharging(@Model.SessionId)">
                                <i class="fas fa-stop"></i> Ngắt Điện Khẩn Cấp
                            </button>
                        }
                        else if (Model.Status == "PoweredOff")
                        {
                            <button class="btn btn-primary w-100" onclick="completeSession(@Model.SessionId)">
                                <i class="fas fa-flag-checkered"></i> Hoàn Tất (Đã Tháo Cáp)
                            </button>
                            <div class="alert alert-warning mt-3 mb-0">
                                <i class="fas fa-exclamation-triangle"></i> <small>Vui lòng đợi khách hàng tháo cáp</small>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Invoice Section -->
            @if (Model.Status == "Completed")
            {
                var invoice = ViewBag.Invoice as ChargingPoint.Models.Invoice;
                if (invoice != null)
                {
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fas fa-file-invoice-dollar"></i> Hóa Đơn</h5>
                        </div>
                        <div class="card-body">
                            <div class="invoice-summary">
                                <div class="invoice-row">
                                    <span>Mã hóa đơn:</span>
                                    <strong>@invoice.InvoiceId</strong>
                                </div>
                                <div class="invoice-row">
                                    <span>Ngày tạo:</span>
                                    <span>@invoice.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                                </div>
                                <hr />
                                <div class="invoice-row">
                                    <span>Chi phí điện:</span>
                                    <strong>@((invoice.TotalAmountService ?? 0).ToString("N0"))₫</strong>
                                </div>
                                <div class="invoice-row">
                                    <span>Thuế VAT:</span>
                                    <span>@((invoice.TotalAmountTax ?? 0).ToString("N0"))₫</span>
                                </div>
                                <hr />
                                <div class="invoice-row total-row">
                                    <span>TỔNG CỘNG:</span>
                                    <strong class="text-success">@((invoice.Total ?? 0).ToString("N0"))₫</strong>
                                </div>
                            </div>
                            @if (invoice.Status == "Unpaid")
                            {
                                <a href="@Url.Action("Detail", "Invoice", new { id = invoice.InvoiceId })" class="btn btn-primary w-100 mt-3">
                                    <i class="fas fa-eye"></i> Xem Chi Tiết
                                </a>
                            }
                            else
                            {
                                <div class="alert alert-success mt-3 mb-0">
                                    <i class="fas fa-check-circle"></i> <strong>Đã thanh toán</strong>
                                </div>
                            }
                        </div>
                    </div>
                }
                else if (canControl)
                {
                    <div class="card shadow-sm mb-4">
                        <div class="card-body text-center">
                            <p>Chưa có hóa đơn</p>
                            <form method="post" action="@Url.Action("GenerateInvoice", "Invoice")">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="sessionId" value="@Model.SessionId" />
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Tạo Hóa Đơn
                                </button>
                            </form>
                        </div>
                    </div>
                }
            }

            <!-- Timeline -->
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Lịch Sử</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        @if (Model.StartTime.HasValue)
                        {
                            <div class="timeline-item">
                                <i class="fas fa-play-circle text-success"></i>
                                <div>
                                    <strong>Bắt đầu sạc</strong>
                                    <div class="text-muted small">@Model.StartTime.Value.ToString("HH:mm dd/MM/yyyy")</div>
                                </div>
                            </div>
                        }
                        @if (Model.PowerOffTime.HasValue)
                        {
                            <div class="timeline-item">
                                <i class="fas fa-power-off text-warning"></i>
                                <div>
                                    <strong>Ngắt điện</strong>
                                    <div class="text-muted small">@Model.PowerOffTime.Value.ToString("HH:mm dd/MM/yyyy")</div>
                                </div>
                            </div>
                        }
                        @if (Model.EndTime.HasValue)
                        {
                            <div class="timeline-item">
                                <i class="fas fa-flag-checkered text-primary"></i>
                                <div>
                                    <strong>Hoàn tất</strong>
                                    <div class="text-muted small">@Model.EndTime.Value.ToString("HH:mm dd/MM/yyyy")</div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const sessionId = @Model.SessionId;
        const status = '@Model.Status';
        let progressInterval;

        $(document).ready(function () {
            if (status === 'Charging' || status === 'PoweredOff') {
                updateProgress();
                progressInterval = setInterval(updateProgress, 5000);
            }
        });

        function updateProgress() {
            $.get('@Url.Action("GetChargingProgress", "ChargingSession")', { sessionId: sessionId })
                .done(function (data) {
                    if (data.success) {
                        $('#currentSOC').text(data.currentSOC.toFixed(1) + '%');
                        $('#chargingProgress').css('width', data.progressPercent + '%');
                        $('#progressText').text(data.progressPercent.toFixed(0) + '%');
                        $('#statusMessage').text(data.message);
                        if (data.remainingTime) {
                            $('#remainingTime').text(`Còn lại: ${Math.floor(data.remainingTime.totalMinutes)} phút`);
                        }
                        if (data.isCompleted) {
                            clearInterval(progressInterval);
                            location.reload();
                        }
                    }
                })
                .fail(function () { console.error('Failed to fetch progress'); });
        }

        function approveCharging(id) {
            Swal.fire({
                title: 'Phê duyệt yêu cầu sạc?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Phê duyệt',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('@Url.Action("AllowCharging", "ChargingSession")', { sessionId: id })
                        .done(function (data) {
                            if (data.success) {
                                Swal.fire('Thành công!', data.message, 'success').then(() => location.reload());
                            } else {
                                Swal.fire('Lỗi!', data.message, 'error');
                            }
                        });
                }
            });
        }

        function rejectCharging(id) {
            Swal.fire({
                title: 'Từ chối yêu cầu?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Từ chối',
                confirmButtonColor: '#d33'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('@Url.Action("RejectCharging", "ChargingSession")', { sessionId: id })
                        .done(function (data) {
                            if (data.success) {
                                Swal.fire('Đã từ chối!', data.message, 'success').then(() => location.reload());
                            }
                        });
                }
            });
        }

        function stopCharging(id) {
            Swal.fire({
                title: 'Ngắt điện khẩn cấp?',
                text: 'Hành động này sẽ dừng sạc ngay lập tức',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('@Url.Action("StopCharging", "ChargingSession")', { sessionId: id })
                        .done(function (data) {
                            if (data.success) {
                                Swal.fire('Đã ngắt điện!', data.message, 'success').then(() => location.reload());
                            }
                        });
                }
            });
        }

        function completeSession(id) {
            Swal.fire({
                title: 'Hoàn tất phiên sạc?',
                text: 'Xác nhận khách hàng đã tháo cáp',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Hoàn tất',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('@Url.Action("CompleteSession", "ChargingSession")', { sessionId: id })
                        .done(function (data) {
                            if (data.success) {
                                Swal.fire('Hoàn tất!', data.message, 'success').then(() => location.reload());
                            } else {
                                Swal.fire('Lỗi!', data.message, 'error');
                            }
                        })
                        .fail(function () { Swal.fire('Lỗi!', 'Không thể hoàn tất', 'error'); });
                }
            });
        }
    </script>
}

@section Styles {
    <style>
        .badge-lg {
            font-size: 1.2rem;
            padding: 10px 20px;
        }

        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }

            .info-item:last-child {
                border-bottom: none;
            }

            .info-item .label {
                color: #6c757d;
            }

        .stat-box {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            color: white;
        }

        .stat-content {
            flex: 1;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #212529;
        }

        .invoice-summary {
            font-size: 0.95rem;
        }

        .invoice-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
        }

        .total-row {
            font-size: 1.2rem;
            font-weight: 700;
            border-top: 2px solid #dee2e6;
            padding-top: 15px !important;
        }

        .timeline {
            position: relative;
            padding-left: 40px;
        }

            .timeline::before {
                content: '';
                position: absolute;
                left: 15px;
                top: 0;
                bottom: 0;
                width: 2px;
                background: #dee2e6;
            }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

            .timeline-item i {
                position: absolute;
                left: -32px;
                background: white;
                font-size: 1.5rem;
            }
    </style>
}