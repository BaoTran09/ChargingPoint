@model ChargingPoint.Models.ChargingSession

@{
    ViewData["Title"] = "Chi tiết phiên sạc";
    var isCharging = Model.Status == "Charging";
    var isPoweredOff = Model.Status == "PoweredOff";
    var isCompleted = Model.Status == "Completed";
    var isRequiring = Model.Status == "Requiring";
    var isStopped = Model.Status == "Stopped";
    
    // Tính CurrentSOC để hiển thị
    var currentSOC = Model.EndSOC ?? Model.StartSOC ?? 0;
}

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a href="javascript:history.back()">Quay lại</a></li>
                    <li class="breadcrumb-item active">Chi tiết phiên sạc</li>
                </ol>
            </nav>
            <h2 class="mb-0">Quản lý phiên sạc > Chi tiết phiên sạc</h2>
        </div>
        <div>
            <span class="badge bg-primary fs-5 me-2">Mã phiên: @Model.SessionId</span>
            <span class="badge bg-@(isCharging ? "success" : isRequiring ? "warning" : isPoweredOff ? "info" : isCompleted ? "primary" : "secondary") fs-5">
                @Model.Status
            </span>
        </div>
    </div>

    <!-- Alert cho xe không phải VinFast -->
    @if (isRequiring)
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>Yêu cầu xác nhận!</strong> Xe không phải VinFast hoặc không tương thích - Cần phê duyệt từ nhân viên.
            <div class="mt-2">
                <button type="button" class="btn btn-success" onclick="approveSession()">
                    Phê duyệt và bắt đầu sạc
                </button>
                <button type="button" class="btn btn-danger ms-2" onclick="rejectSession()">
                    Từ chối
                </button>
            </div>
        </div>
    }

    <!-- Alert khi sạc xong -->
    @if (isPoweredOff)
    {
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <strong>Sạc hoàn tất!</strong> Vui lòng tháo cáp sạc trong vòng 10 phút để tránh phí phạt.
            <button type="button" class="btn btn-primary btn-sm ms-3" onclick="completeSession()">
                Xác nhận đã tháo cáp
            </button>
        </div>
    }

    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-6">
            <!-- Thông tin xe -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Thông tin xe</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless mb-0">
                        <tr>
                            <td class="fw-bold" style="width: 40%;">Tên Xe:</td>
                            <td>@Model.Vehicle?.Model</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Biển số:</td>
                            <td><span class="badge bg-dark fs-6">@Model.Vehicle?.LicensePlate</span></td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Tên chủ xe:</td>
                            <td>@Model.Vehicle?.Customer?.FullName</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Hãng xe:</td>
                            <td>@Model.Vehicle?.Manufacturer</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Thông tin trụ sạc -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Thông tin trụ sạc</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless mb-0">
                        <tr>
                            <td class="fw-bold" style="width: 40%;">Trạm sạc:</td>
                            <td>@Model.Connector?.Charger?.Station?.Name</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Model charger:</td>
                            <td>@Model.Connector?.Charger?.Model</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Connector:</td>
                            <td>
                                <span class="badge bg-info">@Model.Connector?.ConnectorType</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Loại sạc:</td>
                            <td>
                                <span class="badge bg-@(Model.Connector?.Charger?.ChargerType == "DC" ? "danger" : "warning") fs-6">
                                    @Model.Connector?.Charger?.ChargerType
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Công suất:</td>
                            <td><strong class="text-success">@Model.Connector?.Charger?.MaxPowerKW kW</strong></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-6">
            <!-- Theo dõi sạc -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Theo dõi sạc</h5>
                </div>
                <div class="card-body">
                    <!-- Thời gian -->
                    <div class="row text-center mb-4">
                        <div class="col-6">
                            <div class="border rounded p-3 bg-light">
                                <div class="text-muted small mb-1">Thời gian bắt đầu</div>
                                <div class="fs-4 fw-bold text-primary">
                                    @Model.StartTime?.ToString("HH:mm:ss")
                                </div>
                                <div class="small text-muted">
                                    @Model.StartTime?.ToString("dd/MM/yyyy")
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-3 bg-light">
                                <div class="text-muted small mb-1">Dự kiến hoàn thành</div>
                                <div class="fs-4 fw-bold text-success">
                                    @Model.ExpectTime?.ToString("HH:mm:ss")
                                </div>
                                <div class="small text-muted">
                                    @Model.ExpectTime?.ToString("dd/MM/yyyy")
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Bar với SOC -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <div class="text-center">
                                <small class="text-muted d-block">Start SOC</small>
                                <div class="fw-bold fs-5">@Model.StartSOC%</div>
                            </div>
                            <div class="text-center">
                                <small class="text-muted d-block">Current SOC</small>
                                <div class="fw-bold display-4 text-primary" id="currentSOC">
                                    @currentSOC%
                                </div>
                            </div>
                            <div class="text-center">
                                <small class="text-muted d-block">Target SOC</small>
                                <div class="fw-bold fs-5 text-success">@Model.TargetSOC%</div>
                            </div>
                        </div>

                        <!-- Progress bar -->
                        @{
                            var progressPercent = Model.TargetSOC > Model.StartSOC 
                                ? ((currentSOC - Model.StartSOC) / (Model.TargetSOC - Model.StartSOC) * 100) 
                                : 0;
                        }
                        <div class="progress mb-3" style="height: 50px; border: 3px solid #dee2e6; border-radius: 15px;">
                            <div class="progress-bar progress-bar-striped @(isCharging ? "progress-bar-animated" : "") bg-success" 
                                 role="progressbar" 
                                 style="width: @progressPercent%"
                                 id="chargedBar">
                                <span class="fw-bold fs-5" id="progressText">
                                    @currentSOC%
                                </span>
                            </div>
                        </div>

                        <!-- Thời gian còn lại -->
                        @if (isCharging && Model.ExpectTime.HasValue)
                        {
                            <div class="text-center mb-3">
                                <small class="text-muted d-block">Thời gian còn lại ước tính</small>
                                <div class="fs-4 fw-bold text-info" id="remainingTime">
                                    Đang tính...
                                </div>
                            </div>
                        }

                        <!-- Thông tin năng lượng -->
                        @if (Model.EnergyDeliveredKWh.HasValue)
                        {
                            <div class="alert alert-light mb-0">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <small class="text-muted d-block">Năng lượng đã nạp</small>
                                        <strong class="fs-5">@Model.EnergyDeliveredKWh.Value.ToString("F2") kWh</strong>
                                    </div>
                                    @if (Model.OverDueTime.HasValue && Model.OverDueTime > 10)
                                    {
                                        <div class="col-6">
                                            <small class="text-muted d-block">Thời gian trễ</small>
                                            <strong class="fs-5 text-danger">@Model.OverDueTime phút</strong>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Buttons hành động -->
            <div class="card shadow-sm">
                <div class="card-header bg-warning">
                    <h5 class="mb-0">Hành động</h5>
                </div>
                <div class="card-body text-center">
                    @if (isCharging)
                    {
                        <button class="btn btn-danger btn-lg" onclick="stopCharging()">
                            <i class="fas fa-stop"></i> Ngắt điện khẩn cấp
                        </button>
                    }
                    else if (isPoweredOff)
                    {
                        <button class="btn btn-success btn-lg" onclick="completeSession()">
                            <i class="fas fa-check-circle"></i> Xác nhận hoàn tất
                        </button>
                    }
                    else if (isCompleted)
                    {
                        <div class="alert alert-success mb-0">
                            <i class="fas fa-check-circle"></i> Phiên sạc đã hoàn tất
                        </div>
                        @if (Model.EndTime.HasValue)
                        {
                            <small class="text-muted">
                                Kết thúc lúc: @Model.EndTime.Value.ToString("HH:mm:ss dd/MM/yyyy")
                            </small>
                        }
                    }
                    else if (isStopped)
                    {
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-exclamation-triangle"></i> Đã ngắt điện khẩn cấp
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Thông tin chi tiết thêm (nếu cần) -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Chi tiết phiên sạc</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <td class="fw-bold">Meter Start (kWh):</td>
                                    <td>@Model.MeterStartKWh?.ToString("F2")</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Meter Stop (kWh):</td>
                                    <td>@Model.MeterStopKWh?.ToString("F2")</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Năng lượng tiêu thụ:</td>
                                    <td><strong>@Model.EnergyDeliveredKWh?.ToString("F2") kWh</strong></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <td class="fw-bold">Thời gian ngắt điện:</td>
                                    <td>@Model.PowerOffTime?.ToString("HH:mm:ss dd/MM/yyyy")</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Thời gian kết thúc:</td>
                                    <td>@Model.EndTime?.ToString("HH:mm:ss dd/MM/yyyy")</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Cập nhật cuối:</td>
                                    <td>@Model.LastUpdated.ToString("HH:mm:ss dd/MM/yyyy")</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Biến global
        const sessionId = @Model.SessionId;
        const isCharging = @(isCharging ? "true" : "false");
        let updateInterval;
        
        @if (Model.StartTime.HasValue && Model.ExpectTime.HasValue)
        {
            <text>
            const startTime = new Date('@Model.StartTime.Value.ToString("o")');
            const expectTime = new Date('@Model.ExpectTime.Value.ToString("o")');
            const startSOC = @Model.StartSOC;
            const targetSOC = @Model.TargetSOC;
            </text>
        }

        // Hàm format thời gian còn lại
        function formatRemainingTime(seconds) {
            if (seconds <= 0) return "Hoàn tất";
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);

            if (hours > 0) {
                return `${hours} giờ ${minutes} phút`;
            } else if (minutes > 0) {
                return `${minutes} phút ${secs} giây`;
            } else {
                return `${secs} giây`;
            }
        }

        // Hàm cập nhật thời gian còn lại
        function updateRemainingTime() {
            if (typeof expectTime === 'undefined') return;
            
            const now = new Date();
            const remainingMs = expectTime - now;
            const remainingSeconds = Math.max(0, Math.floor(remainingMs / 1000));
            
            const timeElement = document.getElementById('remainingTime');
            if (timeElement) {
                timeElement.textContent = formatRemainingTime(remainingSeconds);
            }
        }

        // Hàm cập nhật progress từ server
        async function updateProgress() {
            try {
                const response = await fetch(`/ChargingSession/UpdateProgress?sessionId=${sessionId}`);
                const data = await response.json();

                if (data.success) {
                    // Cập nhật SOC hiện tại
                    document.getElementById('currentSOC').textContent = data.currentSOC.toFixed(1) + '%';
                    document.getElementById('progressText').textContent = data.currentSOC.toFixed(1) + '%';

                    // Cập nhật progress bar
                    const progressBar = document.getElementById('chargedBar');
                    progressBar.style.width = data.progressPercent + '%';

                    console.log('Progress updated:', data.currentSOC, '%');

                    // Nếu hoàn tất, reload page sau 2 giây
                    if (data.isCompleted) {
                        console.log('Charging completed!');
                        alert(data.message);
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    }
                } else {
                    console.log('Update status:', data.message);
                }
            } catch (error) {
                console.error('Error updating progress:', error);
            }
        }

        // Phê duyệt session (cho xe không phải VinFast)
        async function approveSession() {
            if (!confirm('Xác nhận phê duyệt và bắt đầu sạc cho xe này?')) return;

            try {
                const formData = new FormData();
                formData.append('sessionId', sessionId);

                const response = await fetch('/ChargingSession/AllowCharging', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            } catch (error) {
                alert('Có lỗi xảy ra: ' + error.message);
            }
        }

        // Từ chối session
        async function rejectSession() {
            if (!confirm('Xác nhận từ chối phiên sạc này?')) return;

            try {
                const formData = new FormData();
                formData.append('sessionId', sessionId);

                const response = await fetch('/ChargingSession/RejectCharging', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    window.history.back();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            } catch (error) {
                alert('Có lỗi xảy ra: ' + error.message);
            }
        }

        // Ngắt điện khẩn cấp
        async function stopCharging() {
            if (!confirm('Xác nhận ngắt điện khẩn cấp? Phiên sạc sẽ kết thúc ngay lập tức.')) return;

            try {
                const formData = new FormData();
                formData.append('sessionId', sessionId);

                const response = await fetch('/ChargingSession/StopCharging', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            } catch (error) {
                alert('Có lỗi xảy ra: ' + error.message);
            }
        }

        // Hoàn tất session (khách đã tháo cáp)
        async function completeSession() {
            if (!confirm('Xác nhận khách hàng đã tháo cáp và hoàn tất phiên sạc?')) return;

            try {
                const formData = new FormData();
                formData.append('sessionId', sessionId);

                const response = await fetch('/ChargingSession/CompleteSession', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            } catch (error) {
                alert('Có lỗi xảy ra: ' + error.message);
            }
        }

        // Khởi động khi page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Session detail page loaded, ID:', sessionId);
            console.log('Is charging:', isCharging);

            // Chỉ update nếu đang charging
            if (isCharging) {
                // Cập nhật ngay lập tức
                updateProgress();
                updateRemainingTime();

                // Cập nhật progress mỗi 3 giây
                updateInterval = setInterval(updateProgress, 3000);

                // Cập nhật remaining time mỗi 1 giây
                setInterval(updateRemainingTime, 1000);

                console.log('Auto-update started - refresh every 3 seconds');
            }
        });

        // Dừng update khi rời trang
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
                console.log('Auto-update stopped');
            }
        });
    </script>

    <style>
        .progress {
            border: 3px solid #dee2e6;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-bar {
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

      @*  @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        *@
        .progress-bar-animated {
            animation: pulse 2s ease-in-out infinite;
        }

        .card {
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        @*@media print {
            .btn, nav, .alert, .card-header { 
                display: none !important; 
            }
        }*@

        /* Animation cho số SOC */
        #currentSOC {
            transition: all 0.3s ease;
        }
    </style>
}