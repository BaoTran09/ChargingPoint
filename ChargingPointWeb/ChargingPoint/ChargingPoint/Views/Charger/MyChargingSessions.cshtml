@model IEnumerable<ChargingPoint.Models.ChargingSession>
@{
    ViewData["Title"] = "Đang sạc & Lịch sử";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Lấy phiên đang hoạt động (Charging hoặc PoweredOff)
    var activeSession = Model?.FirstOrDefault(s =>
        s.Status == "Charging" || s.Status == "PoweredOff");

    // Tính % tiến độ an toàn (tránh chia cho 0)
    int progress = 0;
    if (activeSession != null && activeSession.StartSOC.HasValue && activeSession.TargetSOC.HasValue && activeSession.TargetSOC > activeSession.StartSOC)
    {
        var current = activeSession.EndSOC ?? activeSession.StartSOC.Value;
        progress = (int)Math.Min(100, Math.Max(0, (current - activeSession.StartSOC.Value) / (activeSession.TargetSOC.Value - activeSession.StartSOC.Value) * 100));
    }

    // Tính năng lượng đã nạp
    decimal energyDelivered = 0;
    if (activeSession?.Vehicle?.BatteryGrossKWh > 0 && activeSession.StartSOC.HasValue)
    {
        var currentSOC = activeSession.EndSOC ?? activeSession.StartSOC.Value;
        energyDelivered = Math.Round((currentSOC - activeSession.StartSOC.Value) / 100m * activeSession.Vehicle.BatteryGrossKWh.Value, 2);
    }
}

<div class="content-wrapper">
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-5">
        <div>
            <h2 class="fw-bold mb-1">
                <i class="bi bi-lightning-charge-fill text-success me-2"></i>
                Đang sạc & Lịch sử
            </h2>
            <p class="text-secondary mb-0">Theo dõi phiên sạc hiện tại và lịch sử sạc của bạn</p>
        </div>

        @if (activeSession != null)
        {
            <a asp-action="ChargingDetail" asp-route-id="@activeSession.SessionId"
               class="btn btn-success shadow-sm d-flex align-items-center gap-2 px-4 py-3">
                <i class="bi bi-ev-station-fill"></i>
                <span class="fw-medium">Xem phiên đang sạc</span>
            </a>
        }
    </div>

    <!-- Phiên sạc đang hoạt động -->
    @if (activeSession != null)
    {
        <div class="card border-0 shadow-sm mb-5" style="border: 2px solid var(--vgreen); border-radius: var(--radius);">
            <div class="card-body p-5">
                <div class="row g-5 align-items-center">
                    <div class="col-lg-8">
                        <div class="d-flex align-items-center gap-4 mb-4">
                            <div class="avatar bg-success text-white rounded-circle d-flex align-items-center justify-content-center fw-bold shadow"
                                 style="width: 80px; height: 80px; font-size: 2.2rem;">
                                @(activeSession.Vehicle?.LicensePlate?.FirstOrDefault() ?? 'V')
                            </div>
                            <div>
                                <h3 class="fw-bold mb-1">@activeSession.Vehicle?.Model</h3>
                                <p class="mb-1 text-secondary fs-5">
                                    <i class="bi bi-geo-alt-fill text-success me-1"></i>
                                    @activeSession.Connector?.Charger?.Station?.Name
                                </p>
                                <div class="small text-secondary">
                                    Bắt đầu: @activeSession.StartTime:HH:mm dd/MM • 
                                    Dự kiến: @(activeSession.ExpectTime?.ToString("HH:mm") ?? "--:--")
                                </div>
                            </div>
                        </div>

                        <!-- Thanh tiến độ + thông tin -->
                        <div class="row g-4 align-items-center">
                            <div class="col-md-5">
                                <div class="text-center">
                                    <h2 class="fw-bold text-success mb-3">
                                        @(activeSession.EndSOC?.ToString("F1") ?? activeSession.StartSOC?.ToString("F1"))%
                                    </h2>
                                    <div class="progress" style="height: 16px; border-radius: 8px; overflow: hidden;">
                                        <div class="progress-bar bg-success" style="width: @progress%;"></div>
                                    </div>
                                    <div class="mt-3 small text-secondary">
                                        <div>Đã sạc: <strong>@energyDelivered kWh</strong></div>
                                        <div>Tăng: <strong class="text-success">+@((activeSession.EndSOC.GetValueOrDefault() - activeSession.StartSOC.GetValueOrDefault()).ToString("F1"))%
</strong></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-7 text-end">
                                <div class="mb-3">
                                    <h5 class="fw-bold mb-1">Phiên sạc đang hoạt động</h5>
                                    <p class="text-success fs-5 mb-0">
                                        <i class="bi bi-broadcast me-1"></i>
                                        LIVE • Phiên #@activeSession.SessionId
                                    </p>
                                </div>
                                <div class="d-flex gap-3 justify-content-end">
                                    <a asp-action="ChargingDetail" asp-route-id="@activeSession.SessionId"
                                       class="btn btn-success btn-lg px-5 shadow-sm">
                                        <i class="bi bi-graph-up-arrow"></i> Theo dõi realtime
                                    </a>
                                    @if (activeSession.Status == "Charging")
                                    {
                                        <form asp-action="StopMyCharging" asp-route-sessionId="@activeSession.SessionId"
                                              method="post" class="d-inline"
                                              onsubmit="return confirm('Dừng sạc ngay bây giờ?\nXe sẽ ngừng nhận điện.')">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-outline-danger btn-lg px-5">
                                                <i class="bi bi-plug"></i> Dừng sạc
                                            </button>
                                        </form>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Lịch sử sạc -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-bottom py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-semibold">
                <i class="bi bi-clock-history text-primary me-2"></i>
                Lịch sử sạc
                <span class="text-secondary ms-2">(@Model.Count(s => s.Status == "Completed" || s.Status == "Stopped" || s.Status == "PoweredOff")) phiên</span>
            </h5>
        </div>
        <div class="card-body p-0">
            @if (!Model.Any(s => s.Status != "Charging" && s.Status != "PoweredOff"))
            {
                <div class="text-center py-6">
                    <i class="bi bi-receipt fs-1 text-muted opacity-50 mb-3"></i>
                    <p class="text-muted">Chưa có phiên sạc nào hoàn tất</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Mã phiên</th>
                                <th>Trạm sạc</th>
                                <th>Xe</th>
                                <th>Thời gian</th>
                                <th>Năng lượng</th>
                                <th>Trạng thái</th>
                                <th class="text-end pe-4">Chi tiết</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var s in Model.Where(s => s.Status != "Charging" && s.Status != "PoweredOff").OrderByDescending(s => s.StartTime))
                            {
                                var statusClass = s.Status switch
                                {
                                    "Completed" => "bg-info",
                                    "Stopped" => "bg-danger",
                                    "PoweredOff" => "bg-warning text-dark",
                                    "Requiring" => "bg-secondary",
                                    _ => "bg-secondary"
                                };
                                var statusText = s.Status switch
                                {
                                    "Completed" => "Hoàn tất",
                                    "Stopped" => "Bị dừng",
                                    "PoweredOff" => "Đã ngắt điện",
                                    "Requiring" => "Chờ duyệt",
                                    _ => s.Status
                                };

                                <tr>
                                    <td class="ps-4">
                                        <strong class="text-primary">#@s.SessionId</strong>
                                    </td>
                                    <td>
                                        <div class="fw-semibold">@s.Connector?.Charger?.Station?.Name</div>
                                        @* <small class="text-secondary">@s.Connector?.Charger?.C</small> *@
                                    </td>
                                    <td>
                                        <div class="fw-semibold">@s.Vehicle?.Model</div>
                                        <small class="text-secondary">@s.Vehicle?.LicensePlate</small>
                                    </td>
                                    <td>
                                        <small>@s.StartTime:dd/MM HH:mm</small>
                                        @if (s.EndTime.HasValue)
                                        {
                                            <br /><small class="text-success">→ @s.EndTime:HH:mm</small>
                                        }
                                    </td>
                                    <td>
                                        @(s.MeterStopKWh.HasValue && s.MeterStartKWh.HasValue
                                            ? $"{(s.MeterStopKWh.Value - s.MeterStartKWh.Value):F2} kWh"
                                            : "—")
                                    </td>
                                    <td>
                                        <span class="badge @statusClass bg-opacity-10 px-3 py-2 text-@(statusClass.Contains("warning") ? "dark" : statusClass.Replace("bg-", ""))">
                                            @statusText
                                        </span>
                                    </td>
                                    <td class="text-end pe-4">
                                        <a asp-action="ChargingDetail" asp-route-id="@s.SessionId"
                                           class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <!-- Auto refresh nếu đang sạc -->
    @if (Model.Any(s => s.Status == "Charging"))
    {
        <script>
            setInterval(() => location.reload(), 15000);
        </script>
    }
}