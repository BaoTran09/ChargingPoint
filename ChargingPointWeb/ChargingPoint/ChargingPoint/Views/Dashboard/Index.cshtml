@using ChargingPoint.ViewModels
@model DashboardViewModel
@{
    ViewData["Title"] = "Dashboard - Tổng Quan Hệ Thống";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="content-wrapper">
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h2 class="fw-bold mb-1" style="font-size: 28px; color: var(--text-primary);">
                <i class="bi bi-speedometer2 text-success me-2"></i>Dashboard
            </h2>
            <p class="text-secondary mb-0" style="font-size: 14px;">Tổng quan hệ thống trạm sạc V-Green</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" id="refreshBtn">
                <i class="bi bi-arrow-clockwise"></i> Làm mới
            </button>
            <a asp-controller="Report" asp-action="Index" class="btn btn-success">
                <i class="bi bi-file-earmark-bar-graph"></i> Xem báo cáo
            </a>
        </div>
    </div>

    <!-- Stats Cards Row -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm stat-card" style="border-radius: var(--radius);">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-secondary mb-2" style="font-size: 13px;">Tổng trạm sạc</p>
                            <h3 class="fw-bold mb-0" style="color: var(--vgreen);">@Model.TotalStations</h3>
                        </div>
                        <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1);">
                            <i class="bi bi-ev-station-fill text-success"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-graph-up-arrow text-success"></i>
                            Đang hoạt động
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm stat-card" style="border-radius: var(--radius);">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-secondary mb-2" style="font-size: 13px;">Tổng máy sạc</p>
                            <h3 class="fw-bold mb-0" style="color: #3b82f6;">@Model.TotalChargers</h3>
                        </div>
                        <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1);">
                            <i class="bi bi-plug-fill text-primary"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-lightning-charge-fill text-warning"></i>
                            Sẵn sàng phục vụ
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm stat-card" style="border-radius: var(--radius);">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-secondary mb-2" style="font-size: 13px;">Khách hàng</p>
                            <h3 class="fw-bold mb-0" style="color: #8b5cf6;">@Model.TotalCustomers</h3>
                        </div>
                        <div class="stat-icon" style="background: rgba(139, 92, 246, 0.1);">
                            <i class="bi bi-people-fill text-purple"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-person-check-fill" style="color: #8b5cf6;"></i>
                            Đã đăng ký
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm stat-card" style="border-radius: var(--radius);">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-secondary mb-2" style="font-size: 13px;">Doanh thu</p>
                            <h3 class="fw-bold mb-0" style="color: #f59e0b;">@Model.TotalRevenue.ToString("N0") đ</h3>
                        </div>
                        <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1);">
                            <i class="bi bi-cash-stack text-warning"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-arrow-up-right text-success"></i>
                            Tổng thu nhập
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Secondary Stats Row -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card border-0 shadow-sm h-100" style="border-radius: var(--radius); border-left: 4px solid var(--vgreen);">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-battery-charging fs-3 text-success me-3"></i>
                        <div>
                            <h4 class="mb-0 fw-bold">@Model.ActiveSessions</h4>
                            <small class="text-secondary">Đang sạc</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card border-0 shadow-sm h-100" style="border-radius: var(--radius); border-left: 4px solid #3b82f6;">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-check-circle-fill fs-3 text-primary me-3"></i>
                        <div>
                            <h4 class="mb-0 fw-bold">@Model.CompletedSessionsToday</h4>
                            <small class="text-secondary">Hoàn thành hôm nay</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card border-0 shadow-sm h-100" style="border-radius: var(--radius); border-left: 4px solid #f59e0b;">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-lightning-fill fs-3 text-warning me-3"></i>
                        <div>
                            <h4 class="mb-0 fw-bold">@Model.TotalEnergyDeliveredToday.ToString("N1") kWh</h4>
                            <small class="text-secondary">Điện năng hôm nay</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card border-0 shadow-sm h-100" style="border-radius: var(--radius); border-left: 4px solid #ef4444;">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-circle-fill fs-3 text-danger me-3"></i>
                        <div>
                            <h4 class="mb-0 fw-bold">@Model.PendingInvoices</h4>
                            <small class="text-secondary">HĐ chưa thanh toán</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <!-- Revenue Chart -->
        <div class="col-xl-8">
            <div class="card border-0 shadow-sm" style="border-radius: var(--radius);">
                <div class="card-header bg-transparent border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-semibold">
                            <i class="bi bi-graph-up text-success me-2"></i>Doanh thu theo thời gian
                        </h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary period-btn" data-period="day">Ngày</button>
                            <button type="button" class="btn btn-outline-secondary period-btn active" data-period="month">Tháng</button>
                            <button type="button" class="btn btn-outline-secondary period-btn" data-period="year">Năm</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" height="80"></canvas>
                </div>
            </div>
        </div>

        <!-- Charger Type Distribution -->
        <div class="col-xl-4">
            <div class="card border-0 shadow-sm" style="border-radius: var(--radius);">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="mb-0 fw-semibold">
                        <i class="bi bi-pie-chart-fill text-primary me-2"></i>Phân loại máy sạc
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="chargerTypeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Chart & Top Stations -->
    <div class="row g-4 mb-4">
        <!-- Session Chart -->
        <div class="col-xl-8">
            <div class="card border-0 shadow-sm" style="border-radius: var(--radius);">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="mb-0 fw-semibold">
                        <i class="bi bi-activity text-info me-2"></i>Phiên sạc 30 ngày qua
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="sessionChart" height="80"></canvas>
                </div>
            </div>
        </div>

        <!-- Top Stations -->
        <div class="col-xl-4">
            <div class="card border-0 shadow-sm" style="border-radius: var(--radius);">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="mb-0 fw-semibold">
                        <i class="bi bi-star-fill text-warning me-2"></i>Top trạm hoạt động
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        @if (Model.TopStations != null)
                        {
                            @foreach (dynamic station in (IEnumerable<dynamic>)Model.TopStations)
                            {
                                <div class="list-group-item px-0 py-3 border-0">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1 fw-semibold">@station.Name</h6>
                                            <small class="text-secondary">@station.Address</small>
                                        </div>
                                        <span class="badge bg-success rounded-pill">@station.SessionCount phiên</span>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Sessions -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="border-radius: var(--radius);">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="mb-0 fw-semibold">
                        <i class="bi bi-clock-history text-secondary me-2"></i>Phiên sạc gần đây
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th>Mã phiên</th>
                                    <th>Trạm sạc</th>
                                    <th>Thời gian</th>
                                    <th>Trạng thái</th>
                                    <th>Điện năng</th>
                                    <th>SOC</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var session in Model.RecentSessions)
                                {
                                    <tr>
                                        <td><strong>#@session.SessionId</strong></td>
                                        <td>@session.Connector?.Charger?.Station?.Name</td>
                                        <td>
                                            <small>@session.StartTime?.ToString("dd/MM/yyyy HH:mm")</small>
                                        </td>
                                        <td>
                                            @if (session.Status == "Charging")
                                            {
                                                <span class="badge bg-success">Đang sạc</span>
                                            }
                                            else if (session.Status == "Completed")
                                            {
                                                <span class="badge bg-primary">Hoàn thành</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">@session.Status</span>
                                            }
                                        </td>
                                        <td>
                                            <strong>@((session.MeterStopKWh ?? 0) - (session.MeterStartKWh ?? 0)).ToString("N2") kWh</strong>
                                        </td>
                                        <td>
                                            <small>@session.StartSOC% → @session.EndSOC%</small>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        // Chart.js configuration
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#6b7280';

        let revenueChart, sessionChart, chargerTypeChart;

        // Revenue Chart
        async function initRevenueChart(period = 'month') {
            const response = await fetch(`/Dashboard/GetRevenueChartData?period=${period}`);
            const data = await response.json();

            const labels = data.map(d => d.month || d.date || d.week || d.year);
            const revenues = data.map(d => d.revenue);

            const ctx = document.getElementById('revenueChart');

            if (revenueChart) {
                revenueChart.destroy();
            }

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Doanh thu (VNĐ)',
                        data: revenues,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function (context) {
                                    return 'Doanh thu: ' + context.parsed.y.toLocaleString('vi-VN') + ' đ';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Session Chart
        async function initSessionChart() {
            const response = await fetch('/Dashboard/GetSessionChartData');
            const data = await response.json();

            const labels = data.map(x => {
                if (period === 'day') return x.dateLabel || new Date(x.date).toLocaleDateString('vi-VN');
                if (period === 'month') return x.month;
                if (period === 'year') return x.year;
                return x.weekLabel || x.week || x.date;
            });
            const counts = data.map(d => d.count);
            const energy = data.map(d => d.totalEnergy);

            const ctx = document.getElementById('sessionChart');

            sessionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Số phiên',
                        data: counts,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderRadius: 6,
                        yAxisID: 'y'
                    }, {
                        label: 'Điện năng (kWh)',
                        data: energy,
                        type: 'line',
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // Charger Type Chart
        const chargerTypeData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ChargerTypeDistribution));

        function initChargerTypeChart() {
            const ctx = document.getElementById('chargerTypeChart');

            const labels = chargerTypeData.map(d => d.type);
            const counts = chargerTypeData.map(d => d.count);

            chargerTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: [
                            '#10b981',
                            '#3b82f6',
                            '#f59e0b',
                            '#8b5cf6',
                            '#ef4444'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Initialize all charts
        document.addEventListener('DOMContentLoaded', function () {
            initRevenueChart('month');
            initSessionChart();
            initChargerTypeChart();

            // Period buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const period = this.dataset.period;
                    initRevenueChart(period);
                });
            });

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', function () {
                location.reload();
            });
        });
    </script>

    <style>
        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

            .stat-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1) !important;
            }

        .stat-icon {
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 24px;
        }

        .text-purple {
            color: #8b5cf6;
        }
    </style>
}