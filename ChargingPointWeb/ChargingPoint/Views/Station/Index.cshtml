@model IEnumerable<ChargingPoint.DB.Station>

@{
    ViewData["Title"] = "Index";
}

<h1>Charging Station</h1>

<p>
    <a asp-action="Create">Create New</a>
</p>
<div style="max-height: 400px; overflow-y: auto;margin-bottom: 100px;">
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>@Html.DisplayNameFor(model => model.Tag)</th>
                <th>@Html.DisplayNameFor(model => model.Name)</th>
                <th>@Html.DisplayNameFor(model => model.StationType)</th>
                <th>@Html.DisplayNameFor(model => model.Address)</th>
                <th>@Html.DisplayNameFor(model => model.Latitude)</th>
                <th>@Html.DisplayNameFor(model => model.Longitude)</th>
                <th>@Html.DisplayNameFor(model => model.Notes)</th>
                <th>@Html.DisplayNameFor(model => model.CreatedAt)</th>
                <th>@Html.DisplayNameFor(model => model.BuiltDate)</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@Html.DisplayFor(modelItem => item.Tag)</td>
                    <td>@Html.DisplayFor(modelItem => item.Name)</td>
                    <td>@Html.DisplayFor(modelItem => item.StationType)</td>
                    <td>@Html.DisplayFor(modelItem => item.Address)</td>
                    <td>@Html.DisplayFor(modelItem => item.Latitude)</td>
                    <td>@Html.DisplayFor(modelItem => item.Longitude)</td>
                    <td>@Html.DisplayFor(modelItem => item.Notes)</td>
                    <td>@Html.DisplayFor(modelItem => item.CreatedAt)</td>
                    <td>@Html.DisplayFor(modelItem => item.BuiltDate)</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<script src="~/lib/leaflet/leaflet.js"></script>
<script src="~/lib/leaflet/leaflet.min.js"></script>

<div id="map" style="width:100%;height:400px"></div>

<script>
    var map = L.map('map').setView([21.0278, 105.8342], 13);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', 
    {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var jsModel = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));
    console.log('jsModel:', jsModel);
    
    var location_icon = L.icon({
        iconUrl: '/icon/location_icon.png', 
        iconSize: [25, 45], // size of the icon
        iconAnchor: [15, 45], // point of the icon which will correspond to marker's location
        popupAnchor: [-3, -46], // point from which the popup should open relative to the iconAnchor

    });

    jsModel.forEach(function (item) {
        // Ensure Latitude and Longitude are numbers and valid
        var lat = parseFloat(item.Latitude);
        var lon = parseFloat(item.Longitude);

        if (!isNaN(lat) && !isNaN(lon)) {
            L.marker([lat, lon], { icon: location_icon })
                .addTo(map)
                .bindPopup(item.Name + '<br>' + item.Address);
        } else {
            console.warn('Invalid coordinates for item:', item);
        }
    });

</script>