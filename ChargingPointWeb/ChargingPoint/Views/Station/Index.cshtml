@model IEnumerable<ChargingPoint.DB.Station>
@{
    ViewData["Title"] = "Quản lý trạm sạc";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@using System.Text.Json
@{
    var json = JsonSerializer.Serialize(Model, new JsonSerializerOptions
    {
        Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
    });
}

<div class="content-wrapper">
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h2 class="fw-bold mb-1" style="font-size: 28px; color: var(--text-primary);">Quản lý trạm sạc</h2>
            <p class="text-secondary mb-0" style="font-size: 14px;">Theo dõi toàn bộ hệ thống trạm sạc V-Green</p>
        </div>
        <a asp-action="Create" class="btn btn-success d-flex align-items-center gap-2 px-4 py-2 shadow-sm rounded" style="font-weight: 500;">
            <i class="bi bi-plus-circle-fill"></i> Thêm trạm mới
        </a>
    </div>

    <!-- Search Bar -->
    <div class="card border-0 shadow-sm mb-4" style="border-radius: var(--radius);">
        <div class="card-body p-4">
            <form id="searchForm" class="row g-3 align-items-end">
                <div class="col-lg-6">
                    <label class="form-label fw-medium" style="font-size: 13px; color: var(--text-secondary);">Tìm kiếm</label>
                    <div class="position-relative">
                        <i class="bi bi-search position-absolute" style="top: 50%; left: 14px; transform: translateY(-50%); color: var(--text-secondary); font-size: 16px;"></i>
                        <input type="text" id="searchInput" class="form-control ps-5" style="height: 44px; border-radius: var(--radius); border: 1px solid var(--border-color); font-size: 14px;"
                               placeholder="Tên trạm, địa chỉ, mã trạm..." value="@ViewBag.SearchString" />
                    </div>
                </div>
                <div class="col-lg-4">
                    <label class="form-label fw-medium" style="font-size: 13px; color: var(--text-secondary);">Khu vực</label>
                    <div class="d-flex gap-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="searchNorth" @(ViewBag.SearchNorth == true ? "checked" : "")>
                            <label class="form-check-label" for="searchNorth" style="font-size: 14px;">Miền Bắc</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="searchCenter" @(ViewBag.SearchCenter == true ? "checked" : "")>
                            <label class="form-check-label" for="searchCenter" style="font-size: 14px;">Miền Trung</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="searchSouth" @(ViewBag.SearchSouth == true ? "checked" : "")>
                            <label class="form-check-label" for="searchSouth" style="font-size: 14px;">Miền Nam</label>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2">
                    <button type="submit" class="btn btn-primary w-100" style="height: 44px; font-weight: 500; border-radius: var(--radius);">
                        <i class="bi bi-search"></i> Tìm kiếm
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Map + Table -->
    <div class="row g-4">
        <!-- Map -->
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm h-100" style="border-radius: var(--radius);">
                <div class="card-header bg-transparent border-bottom-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-semibold" style="font-size: 16px;">
                        <i class="bi bi-geo-alt-fill text-success me-2"></i>Bản đồ trạm sạc
                    </h5>
                    <span class="badge bg-success bg-opacity-10 text-success" id="stationCount">@Model.Count() trạm</span>
                </div>
                <div class="card-body p-0">
                    <div id="map" style="height: 600px; border-radius: 0 0 var(--radius) var(--radius);"></div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm h-100" style="border-radius: var(--radius);">
                <div class="card-header bg-transparent border-bottom-0 py-3">
                    <h5 class="mb-0 fw-semibold" style="font-size: 16px;">
                        <i class="bi bi-list-ul text-primary me-2"></i>Danh sách trạm
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light sticky-top" style="z-index: 10;">
                                <tr>
                                    <th class="ps-4" style="font-size: 13px; font-weight: 600; color: var(--text-secondary);">Mã</th>
                                    <th style="font-size: 13px; font-weight: 600; color: var(--text-secondary);">Tên trạm</th>
                                    <th style="font-size: 13px; font-weight: 600; color: var(--text-secondary);">Loại</th>
                                    <th class="text-end pe-4" style="font-size: 13px; font-weight: 600; color: var(--text-secondary);">Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="stationTableBody">
                                @foreach (var s in Model)
                                {
                                    <tr class="align-middle station-row" data-lat="@s.Latitude" data-lon="@s.Longitude" style="cursor: pointer; transition: var(--transition);">
                                        <td class="ps-4"><span class="fw-bold text-primary" style="font-size: 13px;">#@s.Tag</span></td>
                                        <td>
                                            <div class="fw-semibold" style="font-size: 14px; color: var(--text-primary);">@s.Name</div>
                                            <small class="text-secondary" style="font-size: 12px;">@s.Address</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary bg-opacity-10 text-primary" style="font-size: 11px; padding: 4px 10px;">
                                                @(s.StationType == "Public" ? "Công cộng" : "Riêng tư")
                                            </span>
                                        </td>
                                        <td class="text-end pe-4">
                                            <div class="btn-group btn-group-sm" role="group">
                                                <a href="/Charger/Index?stationId=@s.StationId" class="btn btn-outline-info" title="Xem trạm sạc">
                                                    <i class="bi bi-ev-station"></i>
                                                </a>
                                                <a href="/Station/Edit/@s.StationId" class="btn btn-outline-warning" title="Chỉnh sửa">
                                                    <i class="bi bi-pencil-square"></i>
                                                </a>
                                                <a href="/Station/Delete/@s.StationId" class="btn btn-outline-danger" title="Xóa">
                                                    <i class="bi bi-trash"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/smoothness/jquery-ui.css">

    <script>
        let map, markers = L.layerGroup();
        
        // Custom V-Green marker icon
        const vgreenIcon = L.divIcon({
            html: `<div style="background: var(--vgreen); width: 36px; height: 36px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center;">
                       <i class="bi bi-ev-station-fill text-white" style="font-size: 18px;"></i>
                   </div>`,
            iconSize: [36, 36],
            iconAnchor: [18, 36],
            popupAnchor: [0, -36],
            className: 'custom-marker'
        });

        // Selected marker icon
        const selectedIcon = L.divIcon({
            html: `<div style="background: #3b82f6; width: 42px; height: 42px; border-radius: 50%; border: 4px solid white; box-shadow: 0 6px 20px rgba(59,130,246,0.5); display: flex; align-items: center; justify-content: center; animation: pulse 2s infinite;">
                       <i class="bi bi-ev-station-fill text-white" style="font-size: 20px;"></i>
                   </div>`,
            iconSize: [42, 42],
            iconAnchor: [21, 42],
            popupAnchor: [0, -42],
            className: 'selected-marker'
        });

        $(function () {
            // Initialize map
            map = L.map('map', {
                center: [16.0471, 108.2068],
                zoom: 6,
                zoomControl: true,
                scrollWheelZoom: true
            });

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            markers.addTo(map);

            // Load initial data
            const initialData = @Html.Raw(json);
            loadMarkers(initialData);

            // Autocomplete for search
            $("#searchInput").autocomplete({
                source: function(request, response) {
                    $.ajax({
                        url: "/Station/SearchSuggestions",
                        data: { term: request.term },
                        success: function(data) {
                            response(data);
                        }
                    });
                },
                minLength: 2,
                delay: 300,
                select: function(event, ui) {
                    // When user selects from autocomplete, zoom to that station
                    if (ui.item.latitude && ui.item.longitude) {
                        map.setView([ui.item.latitude, ui.item.longitude], 16);
                        highlightStation(ui.item.latitude, ui.item.longitude);
                    }
                }
            });

            // Search form submit
            $("#searchForm").on("submit", function (e) {
                e.preventDefault();
                performSearch();
            });

            // Region checkboxes change
            $("#searchNorth, #searchCenter, #searchSouth").on("change", function() {
                performSearch();
            });

            // Search input with delay
            let searchTimer;
            $("#searchInput").on("keyup", function () {
                clearTimeout(searchTimer);
                searchTimer = setTimeout(performSearch, 600);
            });

            // Table row click event
            $(document).on('click', '.station-row', function() {
                const lat = $(this).data('lat');
                const lon = $(this).data('lon');
                
                if (lat && lon) {
                    // Highlight row
                    $('.station-row').removeClass('table-primary');
                    $(this).addClass('table-primary');
                    
                    // Pan to location
                    map.setView([lat, lon], 16, {
                        animate: true,
                        duration: 0.5
                    });
                    
                    // Highlight marker
                    highlightStation(lat, lon);
                }
            });
        });

        function performSearch() {
            const params = {
                searchString: $("#searchInput").val(),
                searchNorth: $("#searchNorth").is(":checked"),
                searchCenter: $("#searchCenter").is(":checked"),
                searchSouth: $("#searchSouth").is(":checked")
            };

            $.ajax({
                url: "/Station/Search",
                data: params,
                headers: { "X-Requested-With": "XMLHttpRequest" },
                success: function (data) {
                    updateTable(data);
                    loadMarkers(data);
                    updateStationCount(data.length);

                    // Auto zoom based on results
                    if (data.length === 1) {
                        map.setView([data[0].Latitude, data[0].Longitude], 16);
                    } else if (data.length > 0) {
                        const group = new L.featureGroup(markers.getLayers());
                        map.fitBounds(group.getBounds().pad(0.2));
                    } else {
                        // Reset to Vietnam view if no results
                        map.setView([16.0471, 108.2068], 6);
                    }
                },
                error: function() {
                    console.error('Search failed');
                }
            });
        }

        function loadMarkers(data) {
            markers.clearLayers();
            
            if (!data || data.length === 0) {
                return;
            }

            data.forEach(station => {
                if (station.Latitude && station.Longitude) {
                    const marker = L.marker([station.Latitude, station.Longitude], { 
                        icon: vgreenIcon,
                        title: station.Name
                    })
                    .bindPopup(`
                        <div style="min-width: 200px;">
                            <h6 style="margin: 0 0 8px 0; font-weight: 600; color: var(--text-primary);">${station.Name}</h6>
                            <p style="margin: 0 0 6px 0; font-size: 13px; color: var(--text-secondary);">
                                <i class="bi bi-geo-alt-fill text-success me-1"></i>${station.Address}
                            </p>
                            <p style="margin: 0 0 8px 0; font-size: 12px;">
                                <span class="badge bg-primary bg-opacity-10 text-primary">#${station.Tag}</span>
                                <span class="badge bg-success bg-opacity-10 text-success">${station.StationType === 'Public' ? 'Công cộng' : 'Riêng tư'}</span>
                            </p>
                            <a href="/Charger/Index?stationId=${station.StationId}" class="btn btn-sm btn-success w-100" style="font-size: 12px;">
                                <i class="bi bi-ev-station-fill"></i> Xem chi tiết
                            </a>
                        </div>
                    `, {
                        maxWidth: 300,
                        className: 'custom-popup'
                    })
                    .addTo(markers);
                }
            });
        }

        function updateTable(data) {
            const tbody = $("#stationTableBody");
            tbody.empty();

            if (!data || data.length === 0) {
                tbody.append(`
                    <tr>
                        <td colspan="4" class="text-center py-5">
                            <i class="bi bi-inbox" style="font-size: 48px; color: var(--text-secondary); opacity: 0.5;"></i>
                            <p class="text-muted mt-3 mb-0">Không tìm thấy trạm sạc nào</p>
                        </td>
                    </tr>
                `);
                return;
            }

            data.forEach(s => {
                const row = `
                    <tr class="align-middle station-row" data-lat="${s.Latitude}" data-lon="${s.Longitude}" style="cursor: pointer; transition: var(--transition);">
                        <td class="ps-4"><span class="fw-bold text-primary" style="font-size: 13px;">#${s.Tag}</span></td>
                        <td>
                            <div class="fw-semibold" style="font-size: 14px; color: var(--text-primary);">${s.Name}</div>
                            <small class="text-secondary" style="font-size: 12px;">${s.Address}</small>
                        </td>
                        <td>
                            <span class="badge bg-primary bg-opacity-10 text-primary" style="font-size: 11px; padding: 4px 10px;">
                                ${s.StationType === "Public" ? "Công cộng" : "Riêng tư"}
                            </span>
                        </td>
                        <td class="text-end pe-4">
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="/Charger/Index?stationId=${s.StationId}" class="btn btn-outline-info" title="Xem trạm sạc">
                                    <i class="bi bi-ev-station"></i>
                                </a>
                                <a href="/Station/Edit/${s.StationId}" class="btn btn-outline-warning" title="Chỉnh sửa">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                                <a href="/Station/Delete/${s.StationId}" class="btn btn-outline-danger" title="Xóa">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function updateStationCount(count) {
            $("#stationCount").text(`${count} trạm`);
        }

        function highlightStation(lat, lon) {
            // Find and temporarily highlight the marker
            markers.eachLayer(function(layer) {
                if (layer.getLatLng().lat === lat && layer.getLatLng().lng === lon) {
                    layer.openPopup();
                }
            });
        }
    </script>

    <style>
        /* Map styling */
        #map {
            border-radius: 0 0 var(--radius) var(--radius);
        }

        .leaflet-popup-content-wrapper {
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
        }

        .leaflet-popup-content {
            margin: 16px;
        }

        /* Table row hover */
        .station-row:hover {
            background: var(--bg-secondary) !important;
        }

        .station-row.table-primary {
            background: var(--vgreen-light) !important;
        }

        [data-bs-theme="dark"] .station-row.table-primary {
            background: rgba(16, 185, 129, 0.15) !important;
        }

        /* Marker animation */
        @@keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        /* Custom scrollbar for table */
        .table-responsive::-webkit-scrollbar {
            width: 6px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Button group styling */
        .btn-group-sm > .btn {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* Autocomplete styling */
        .ui-autocomplete {
            max-height: 300px;
            overflow-y: auto;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
        }

        .ui-menu-item {
            padding: 8px 16px;
            font-size: 14px;
            color: var(--text-primary);
        }

        .ui-menu-item:hover {
            background: var(--bg-secondary);
        }

        .ui-state-active {
            background: var(--vgreen-light) !important;
            border-color: var(--vgreen) !important;
            color: var(--vgreen-dark) !important;
        }
    </style>
}