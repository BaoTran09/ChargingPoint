@model ChargingPoint.Models.IndividualVehicle
@{
    var isNew = string.IsNullOrEmpty(Model.VIN);
    var title = isNew ? "Đăng ký xe mới" : "Chỉnh sửa thông tin xe";
    var type = ViewBag.Type as string ?? "Car";

    // Action hướng về CreateVehicle hoặc EditVehicle trong CustomerController
    var action = isNew ? "CreateVehicle" : "EditVehicle";
}

<div class="modal fade" id="vehicleModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-@(type == "Car" ? "primary" : "success") text-white">
                <h5 class="modal-title">
                    <i class="fas fa-@(type == "Car" ? "car" : "motorcycle") me-2"></i>
                    @title
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form id="vehicleForm"
                  hx-post="@Url.Action(action, "Customer")"
                  hx-target="#vehicleList"
                  hx-swap="outerHTML">

                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="CustomerId" />

                <div class="modal-body">
                    <div class="row g-3">
                        @if (isNew)
                        {
                            <div class="col-12">
                                <label class="form-label fw-bold">Chọn mẫu xe hệ thống hỗ trợ <span class="text-danger">*</span></label>
                                <select asp-for="VehicleId" asp-items="ViewBag.VehicleModels" class="form-select select2" required>
                                    <option value="">-- Chọn mẫu xe (Ví dụ: VinFast VF8) --</option>
                                </select>
                                <div class="form-text text-muted">Thông số kỹ thuật (Pin, Sạc) sẽ tự động áp dụng theo mẫu xe.</div>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="VIN" class="form-label fw-bold">Số khung (VIN) <span class="text-danger">*</span></label>
                                <input asp-for="VIN" class="form-control" placeholder="Nhập 17 ký tự số khung" required />
                                <span asp-validation-for="VIN" class="text-danger"></span>
                            </div>
                        }
                        else
                        {
                            <input type="hidden" asp-for="VIN" />
                            <input type="hidden" asp-for="VehicleId" />
                            <div class="col-12">
                                <div class="alert alert-secondary py-2">
                                    <strong>Xe:</strong> @Model.Vehicle?.Manufacturer @Model.Vehicle?.Model - <strong>VIN:</strong> @Model.VIN
                                </div>
                            </div>
                        }

                        <div class="col-md-6">
                            <label asp-for="LicensePlate" class="form-label fw-bold">Biển số xe <span class="text-danger">*</span></label>
                            <input asp-for="LicensePlate" class="form-control" placeholder="Ví dụ: 30H-123.45" required />
                            <span asp-validation-for="LicensePlate" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Color" class="form-label fw-bold">Màu sắc</label>
                            <input asp-for="Color" class="form-control" placeholder="Ví dụ: Trắng, Xanh..." />
                        </div>

                        <div class="col-md-6">
                            <label asp-for="BatterySOH" class="form-label fw-bold">Tình trạng Pin (SOH %)</label>
                            <div class="input-group">
                                <input asp-for="BatterySOH" type="number" class="form-control" placeholder="95" min="1" max="100" />
                                <span class="input-group-text">%</span>
                            </div>
                            <div class="form-text">Độ chai pin thực tế (nếu biết).</div>
                        </div>

                        <div class="col-12">
                            <label asp-for="Note" class="form-label fw-bold">Ghi chú cá nhân</label>
                            <textarea asp-for="Note" class="form-control" rows="2" placeholder="Ví dụ: Xe chuyên đi tỉnh, xe vợ lái..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                    <button type="submit" class="btn btn-@(type == "Car" ? "primary" : "success") px-4">
                        <i class="fas fa-save me-2"></i> Lưu thông tin
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    (function () {
        var modalEl = document.getElementById('vehicleModal');
        var modal = new bootstrap.Modal(modalEl);
        modal.show();

        // Xử lý HTMX thành công
        modalEl.addEventListener('htmx:afterOnRequest', function (evt) {
            if (evt.detail.successful) {
                modal.hide();
                // Xóa backdrop thủ công nếu bị kẹt
                document.body.classList.remove('modal-open');
                var backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) backdrop.remove();
            }
        });

        // Tự động xóa modal khỏi DOM sau khi đóng để không bị rác
        modalEl.addEventListener('hidden.bs.modal', function () {
            modalEl.remove();
        });
    })();
</script>