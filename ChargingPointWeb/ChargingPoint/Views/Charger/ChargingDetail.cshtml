@model ChargingPoint.Models.ChargingSession
@{
    ViewData["Title"] = "Chi tiết phiên sạc";
    var invoice = ViewBag.Invoice as ChargingPoint.Models.Invoice;
    var isActive = Model.Status == "Charging";
}

<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-lightning-charge-fill text-success"></i>
                        Phiên sạc #@Model.SessionId
                    </h2>
                    <p class="text-muted mb-0">
                        @Model.IndividualVehicle?.Vehicle?.Manufacturer @Model.IndividualVehicle?.Vehicle?.Model
                        @if (!string.IsNullOrEmpty(Model.IndividualVehicle?.LicensePlate))
                        {
                            <span> - @Model.IndividualVehicle.LicensePlate</span>
                        }
                    </p>
                </div>
                <div>
                    <a href="@Url.Action("MyChargingSessions")" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Quay lại
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column: Charging Progress -->
        <div class="col-lg-8">
            <!-- Status Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-body text-center py-5">
                    <div class="mb-3">
                        <span class="badge badge-lg @GetStatusClass(Model.Status)" style="font-size: 1.2rem; padding: 0.5rem 1.5rem;">
                            <i class="bi bi-@GetStatusIcon(Model.Status)"></i>
                            @GetStatusText(Model.Status)
                        </span>
                    </div>

                    <!-- Battery Animation -->
                    <div class="position-relative mx-auto mb-4" style="width: 200px; height: 200px;">
                        <svg width="200" height="200" viewBox="0 0 200 200">
                            <!-- Background circle -->
                            <circle cx="100" cy="100" r="80" fill="none" stroke="#e9ecef" stroke-width="20" />
                            <!-- Progress circle -->
                            <circle id="progressCircle"
                                    cx="100" cy="100" r="80"
                                    fill="none"
                                    stroke="#28a745"
                                    stroke-width="20"
                                    stroke-dasharray="502.65"
                                    stroke-dashoffset="502.65"
                                    transform="rotate(-90 100 100)"
                                    style="transition: stroke-dashoffset 1s ease;" />
                        </svg>
                        <div class="position-absolute top-50 start-50 translate-middle text-center">
                            <div class="fs-1 fw-bold text-success" id="currentSOCDisplay">
                                @((Model.EndSOC ?? Model.StartSOC ?? 0).ToString("F1"))%
                            </div>
                            <small class="text-muted">Pin hiện tại</small>
                        </div>
                    </div>

                    <!-- Progress Info -->
                    <div class="row g-3 text-center">
                        <div class="col-4">
                            <div class="text-muted small">Bắt đầu</div>
                            <div class="fs-5 fw-bold">@(Model.StartSOC?.ToString("F1") ?? "0")%</div>
                        </div>
                        <div class="col-4">
                            <div class="text-muted small">Mục tiêu</div>
                            <div class="fs-5 fw-bold text-primary">@(Model.TargetSOC?.ToString("F1") ?? "0")%</div>
                        </div>
                        <div class="col-4">
                            <div class="text-muted small">Năng lượng</div>
                            <div class="fs-5 fw-bold text-info" id="energyDisplay">
                                @((Model.EnergyDeliveredKWh ?? 0).ToString("F2")) kWh
                            </div>
                        </div>
                    </div>

                    @if (isActive)
                    {
                        <!-- Time Remaining -->
                        <div class="mt-4">
                            <div class="text-muted small mb-2">Thời gian còn lại</div>
                            <div class="fs-3 fw-bold text-primary" id="timeRemaining">--:--</div>
                            <small class="text-muted">Hoàn thành lúc: @Model.ExpectTime?.ToString("HH:mm")</small>
                        </div>

                        <!-- Stop Button -->
                        <div class="mt-4">
                            <button type="button" class="btn btn-danger btn-lg" id="stopChargingBtn">
                                <i class="bi bi-stop-circle-fill"></i> Dừng sạc
                            </button>
                        </div>
                    }
                </div>
            </div>

            <!-- Details Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Thông tin chi tiết</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <small class="text-muted">Trạm sạc</small>
                                <div class="fw-semibold">@Model.Connector?.Charger?.Station?.Name</div>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">Trụ sạc</small>
                                <div class="fw-semibold">
                                    @Model.Connector?.Charger?.Name
                                    <span class="badge bg-primary">@Model.Connector?.Charger?.ChargerType</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">Connector</small>
                                <div class="fw-semibold">#@Model.Connector?.ConnectorIndex - @Model.Connector?.ConnectorType</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <small class="text-muted">Bắt đầu</small>
                                <div class="fw-semibold">@Model.StartTime?.ToString("HH:mm:ss dd/MM/yyyy")</div>
                            </div>
                            @if (Model.EndTime.HasValue)
                            {
                                <div class="mb-3">
                                    <small class="text-muted">Kết thúc</small>
                                    <div class="fw-semibold">@Model.EndTime?.ToString("HH:mm:ss dd/MM/yyyy")</div>
                                </div>
                            }
                            <div class="mb-3">
                                <small class="text-muted">Khách hàng</small>
                                <div class="fw-semibold">@Model.IndividualVehicle?.Customer?.FullName</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Vehicle & Invoice -->
        <div class="col-lg-4">
            <!-- Vehicle Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-car-front-fill"></i> Thông tin xe</h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <strong>@Model.IndividualVehicle?.Vehicle?.Manufacturer @Model.IndividualVehicle?.Vehicle?.Model</strong>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.IndividualVehicle?.LicensePlate))
                    {
                        <div class="mb-2">
                            <small class="text-muted">Biển số:</small>
                            <span class="fw-semibold">@Model.IndividualVehicle.LicensePlate</span>
                        </div>
                    }
                    <div class="mb-2">
                        <small class="text-muted">VIN:</small>
                        <span class="font-monospace small">@Model.VIN</span>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Dung lượng pin:</small>
                        <span class="fw-semibold">@Model.IndividualVehicle?.Vehicle?.BatteryGrossKWh kWh</span>
                    </div>
                    <div>
                        <small class="text-muted">Công suất sạc:</small>
                        <div>
                            @if (Model.Connector?.Charger?.ChargerType == "AC")
                            {
                                <span class="badge bg-info">AC: @Model.IndividualVehicle?.Vehicle?.MaxAcChargeKW kW</span>
                            }
                            else
                            {
                                <span class="badge bg-warning">DC: @Model.IndividualVehicle?.Vehicle?.MaxDcChargeKW kW</span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoice Card -->
            @if (invoice != null)
            {
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="bi bi-receipt"></i> Hóa đơn</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted">Số hóa đơn</small>
                            <div class="fw-bold">#@invoice.InvoiceNumber</div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Tổng tiền</small>
                            <div class="fs-4 fw-bold text-success">@invoice.Total?.ToString("N0") đ</div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Trạng thái</small>
                            <div>
                                <span class="badge @(invoice.Status == "Paid" ? "bg-success" : "bg-warning")">
                                    @invoice.Status
                                </span>
                            </div>
                        </div>
                        <a href="#" class="btn btn-outline-success btn-sm w-100">
                            <i class="bi bi-file-earmark-pdf"></i> Xem hóa đơn
                        </a>
                    </div>
                </div>
            }
            else if (Model.Status == "Completed")
            {
                <div class="alert alert-info">
                    <i class="bi bi-clock-history"></i> Hóa đơn đang được tạo...
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            const sessionId = @Model.SessionId;
            const isActive = '@Model.Status' === 'Charging';
            let progressInterval;

            if (isActive) {
                // Poll progress every 2 seconds
                progressInterval = setInterval(updateProgress, 2000);
                updateProgress(); // Initial call
            } else {
                // Update circle for completed session
                updateProgressCircle(@((Model.EndSOC ?? Model.StartSOC ?? 0)));
            }

            function updateProgress() {
                $.ajax({
                    url: '@Url.Action("GetChargingProgress")',
                    data: { sessionId: sessionId },
                    success: function(response) {
                        if (response.success) {
                            // Update SOC
                            $('#currentSOCDisplay').text(response.currentSOC.toFixed(1) + '%');

                            // Update progress circle
                            updateProgressCircle(response.currentSOC);

                            // Update energy
                            $('#energyDisplay').text(response.energyDeliveredKWh.toFixed(2) + ' kWh');

                            // Update time remaining
                            const minutes = Math.floor(response.remainingSeconds / 60);
                            const seconds = response.remainingSeconds % 60;
                            $('#timeRemaining').text(
                                String(minutes).padStart(2, '0') + ':' +
                                String(seconds).padStart(2, '0')
                            );

                            // Check if completed
                            if (response.status !== 'Charging') {
                                clearInterval(progressInterval);
                                setTimeout(() => location.reload(), 2000);
                            }
                        }
                    }
                });
            }

            function updateProgressCircle(soc) {
                const circumference = 502.65;
                const startSOC = @(Model.StartSOC ?? 0);
                const targetSOC = @(Model.TargetSOC ?? 100);

                const progress = (soc - startSOC) / (targetSOC - startSOC);
                const offset = circumference - (progress * circumference);

                $('#progressCircle').css('stroke-dashoffset', offset);
            }

            // Stop charging
            $('#stopChargingBtn').on('click', function() {
                Swal.fire({
                    title: 'Xác nhận dừng sạc?',
                    text: 'Bạn có chắc muốn dừng sạc xe ngay bây giờ?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Dừng sạc',
                    cancelButtonText: 'Hủy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Đang dừng...');

                        $.ajax({
                            url: '@Url.Action("StopCharging")',
                            method: 'POST',
                            data: {
                                sessionId: sessionId,
                                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                            },
                            success: function(response) {
                                if (response.success) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Đã dừng sạc',
                                        text: response.message
                                    }).then(() => {
                                        location.reload();
                                    });
                                } else {
                                    Swal.fire('Lỗi', response.message, 'error');
                                }
                            },
                            error: function() {
                                Swal.fire('Lỗi', 'Có lỗi xảy ra', 'error');
                            }
                        });
                    }
                });
            });
        });
    </script>
}

@functions {
    string GetStatusClass(string status)
    {
        return status switch
        {
            "Charging" => "bg-success",
            "Completed" => "bg-primary",
            "Stopped" => "bg-warning",
            "PoweredOff" => "bg-info",
            _ => "bg-secondary"
        };
    }

    string GetStatusIcon(string status)
    {
        return status switch
        {
            "Charging" => "lightning-charge-fill",
            "Completed" => "check-circle-fill",
            "Stopped" => "stop-circle-fill",
            "PoweredOff" => "power",
            _ => "dash-circle"
        };
    }

    string GetStatusText(string status)
    {
        return status switch
        {
            "Charging" => "Đang sạc",
            "Completed" => "Hoàn tất",
            "Stopped" => "Đã dừng",
            "PoweredOff" => "Ngắt điện",
            _ => status
        };
    }
}

@Html.AntiForgeryToken()