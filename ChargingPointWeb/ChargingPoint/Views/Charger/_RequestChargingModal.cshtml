@model ChargingPoint.ViewModels.RequestChargingViewModel

<div class="modal fade" id="requestChargingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-lightning-charge-fill"></i> Yêu cầu sạc
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <form id="chargingRequestForm">
                @Html.AntiForgeryToken()
                <input type="hidden" name="ConnectorId" value="@Model.ConnectorId" />
                
                <div class="modal-body">
                    <!-- Thông tin trạm -->
                    <div class="alert alert-info">
                        <strong><i class="bi bi-info-circle"></i> Thông tin trụ sạc</strong>
                        <div class="mt-2">
                            <div class="mb-1">
                                <small class="text-muted">Trạm:</small>
                                <strong>@Model.StationName</strong>
                            </div>
                            <div class="mb-1">
                                <small class="text-muted">Trụ sạc:</small>
                                <strong>@Model.ChargerName</strong>
                            </div>
                            <div>
                                <span class="badge bg-primary">@Model.ChargerType</span>
                                <span class="badge bg-info">@Model.ChargerMaxPower kW</span>
                                <span class="badge bg-success">Connector #@Model.Connector.ConnectorIndex</span>
                            </div>
                        </div>
                    </div>

                    <!-- Chọn xe -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-car-front-fill"></i> Chọn xe của bạn
                            <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" name="VIN" id="vehicleSelect" required>
                            <option value="">-- Chọn xe --</option>
                            @foreach (var vehicle in Model.IndividualVehicles)
                            {
                                var batteryInfo = vehicle.BatterySOC.HasValue ? $"{vehicle.BatterySOC}%" : "N/A";
                                var licensePlate = !string.IsNullOrEmpty(vehicle.LicensePlate) ? $" - {vehicle.LicensePlate}" : "";
                                
                                <option value="@vehicle.VIN" 
                                        data-soc="@(vehicle.BatterySOC ?? 0)"
                                        data-model="@vehicle.Vehicle.Model"
                                        data-battery="@vehicle.Vehicle.BatteryGrossKWh">
                                    @vehicle.Vehicle.Manufacturer @vehicle.Vehicle.Model@licensePlate (Pin: @batteryInfo)
                                </option>
                            }
                        </select>
                    </div>

                    <!-- Hiển thị thông tin xe đã chọn -->
                    <div id="vehicleInfo" class="alert alert-light d-none">
                        <div class="row g-2">
                            <div class="col-6">
                                <small class="text-muted">Pin hiện tại:</small>
                                <div class="fs-5 fw-bold text-primary" id="currentSOC">--%</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Dung lượng pin:</small>
                                <div class="fs-6 fw-bold" id="batteryCapacity">-- kWh</div>
                            </div>
                        </div>
                    </div>

                    <!-- Mức pin mong muốn -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-battery-charging"></i> Mức pin mong muốn
                            <span class="text-danger">*</span>
                        </label>
                        <input type="range" 
                               class="form-range" 
                               name="TargetSOC" 
                               id="targetSOCRange" 
                               min="1" 
                               max="100" 
                               value="80" 
                               step="1">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">0%</span>
                            <span class="fs-4 fw-bold text-success" id="targetSOCDisplay">80%</span>
                            <span class="text-muted">100%</span>
                        </div>
                    </div>

                    <!-- Ước tính -->
                    <div id="estimateInfo" class="alert alert-success d-none">
                        <strong><i class="bi bi-calculator"></i> Ước tính:</strong>
                        <div class="mt-2">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Năng lượng cần sạc:</span>
                                <strong id="energyEstimate">-- kWh</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Thời gian dự kiến:</span>
                                <strong id="timeEstimate">-- phút</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Warning -->
                    <div class="alert alert-warning">
                        <small>
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <strong>Lưu ý:</strong> Thời gian sạc thực tế có thể khác do điều kiện pin và nhiệt độ.
                        </small>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Hủy
                    </button>
                    <button type="submit" class="btn btn-success" id="submitBtn">
                        <i class="bi bi-lightning-charge-fill"></i> Bắt đầu sạc
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        const chargerMaxPower = @(Model.ChargerMaxPower ?? 0);
        let currentSOC = 0;
        let batteryCapacity = 0;

        // Khi chọn xe
        $('#vehicleSelect').on('change', function() {
            const selectedOption = $(this).find(':selected');
            currentSOC = parseInt(selectedOption.data('soc')) || 0;
            batteryCapacity = parseFloat(selectedOption.data('battery')) || 0;

            if (currentSOC > 0) {
                $('#vehicleInfo').removeClass('d-none');
                $('#currentSOC').text(currentSOC + '%');
                $('#batteryCapacity').text(batteryCapacity + ' kWh');
                
                // Set min của slider = currentSOC + 1
                $('#targetSOCRange').attr('min', currentSOC + 1);
                $('#targetSOCRange').val(Math.max(currentSOC + 1, 80));
                updateTargetSOC();
            } else {
                $('#vehicleInfo').addClass('d-none');
                alert('Không xác định được mức pin hiện tại của xe');
            }
        });

        // Khi kéo slider
        $('#targetSOCRange').on('input', function() {
            updateTargetSOC();
        });

        function updateTargetSOC() {
            const targetSOC = parseInt($('#targetSOCRange').val());
            $('#targetSOCDisplay').text(targetSOC + '%');

            // Tính ước lượng
            if (currentSOC > 0 && batteryCapacity > 0 && targetSOC > currentSOC) {
                const socDelta = targetSOC - currentSOC;
                const energyNeeded = (socDelta / 100) * batteryCapacity;
                const timeHours = energyNeeded / chargerMaxPower;
                const timeMinutes = Math.ceil(timeHours * 60);

                $('#energyEstimate').text(energyNeeded.toFixed(2) + ' kWh');
                $('#timeEstimate').text(timeMinutes + ' phút');
                $('#estimateInfo').removeClass('d-none');
            } else {
                $('#estimateInfo').addClass('d-none');
            }
        }

        // Submit form
        $('#chargingRequestForm').on('submit', function(e) {
            e.preventDefault();

            const vin = $('#vehicleSelect').val();
            if (!vin) {
                alert('Vui lòng chọn xe');
                return;
            }

            const targetSOC = parseInt($('#targetSOCRange').val());
            if (targetSOC <= currentSOC) {
                alert('Mức pin mong muốn phải lớn hơn mức pin hiện tại (' + currentSOC + '%)');
                return;
            }

            const $btn = $('#submitBtn');
            $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...');

            $.ajax({
                url: '@Url.Action("SubmitChargingRequest")',
                method: 'POST',
                data: $(this).serialize(),
                success: function(response) {
                    if (response.success) {
                        $('#requestChargingModal').modal('hide');
                        
                        // Show success message
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công!',
                            html: `
                                <p>${response.message}</p>
                                <p class="mb-1"><strong>Thời gian dự kiến:</strong> ${response.estimatedMinutes} phút</p>
                                <p class="mb-0"><strong>Hoàn thành lúc:</strong> ${response.expectTime}</p>
                            `,
                            confirmButtonText: 'Xem phiên sạc',
                            showCancelButton: true,
                            cancelButtonText: 'Đóng'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = response.redirectUrl;
                            } else {
                                location.reload();
                            }
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi',
                            text: response.message
                        });
                        $btn.prop('disabled', false).html('<i class="bi bi-lightning-charge-fill"></i> Bắt đầu sạc');
                    }
                },
                error: function() {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Có lỗi xảy ra. Vui lòng thử lại.'
                    });
                    $btn.prop('disabled', false).html('<i class="bi bi-lightning-charge-fill"></i> Bắt đầu sạc');
                }
            });
        });
    });
</script>